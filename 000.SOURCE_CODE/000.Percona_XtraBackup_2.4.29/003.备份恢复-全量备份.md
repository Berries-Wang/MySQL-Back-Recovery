# 全量备份
## The Backup Cycle -Full Backups
### Backup
```shell
    wei@Berries-Wang:$  ./xtrabackup --user=root --password=123456 -S /tmp/mysql3309.sock  --backup --target-dir=${back_dir}

    # The backup can take a long time, depending on how large the database is. It is safe to cancel at any time, because it does not modify the database.

```

### Recovery
After you made a backup with the xtrabackup --backup option, you’ll first need to prepare it in order to restore it. Data files are not point-in-time consistent until they’ve been prepared, because they were copied at different times as the program ran, and they might have been changed while this was happening. If you try to start InnoDB with these data files, it will detect corruption and crash itself to prevent you from running on damaged data. The xtrabackup --prepare step makes the files perfectly consistent at a single instant in time, so you can run InnoDB on them. (在使用xtrabackup --backup选项进行备份之后，首先需要准备备份以便恢复。在准备好数据文件之前，它们在时间点上是不一致的，因为它们是在程序运行时的不同时间复制的，并且在此期间它们可能已经被更改了。如果您尝试用这些数据文件启动InnoDB，它将检测损坏并自行崩溃以防止您在损坏的数据上运行。xtrabackup --prepare步骤使文件在一个瞬间完全一致，因此您可以在它们上运行InnoDB。)

You can run the prepare operation on any machine; it does not need to be on the originating server or the server to which you intend to restore. You can copy the backup to a utility server and prepare it there.(您可以在任何机器上运行准备操作;它不需要位于原始服务器或打算恢复到的服务器上。您可以将备份复制到实用程序服务器并在那里进行准备。)

During the prepare operation, xtrabackup boots up a kind of modified InnoDB that’s embedded inside it (the libraries it was linked against). The modifications are necessary to disable InnoDB’s standard safety checks, such as complaining that the log file isn’t the right size, which aren’t appropriate for working with backups. These modifications are only for the xtrabackup binary; you don’t need a modified InnoDB to use xtrabackup for your backups.(在准备操作期间，xtrabackup启动了一种嵌入其中的修改过的InnoDB(它所链接的库)。这些修改对于禁用InnoDB的标准安全检查是必要的，例如抱怨日志文件大小不合适，这不适合与备份一起工作。这些修改只适用于xtrabackup二进制文件;你不需要一个修改过的InnoDB来使用xtrabackup进行备份。)

The prepare step uses this embedded InnoDB to perform crash recovery on the copied data files, using the copied log file. The prepare step is very simple to use: you simply run xtrabackup --prepare option and tell it which directory to prepare, for example, to prepare the previously taken backup run:(准备步骤使用这个内嵌的InnoDB对复制的数据文件执行崩溃恢复，使用复制的日志文件。准备步骤使用起来非常简单:你只需运行xtrabbackup --prepare option并告诉它准备哪个目录，例如，准备之前的备份运行:)
```shell
    wei@Berries-Wang:$ ./xtrabackup --user=root --password=123456 -S /tmp/mysql3309.sock  --prepare --target-dir=${back_dir}
```

When this finishes, you should see an InnoDB shutdown with a message such as the following, where again the value of LSN will depend on your system:
```txt
   InnoDB: FTS optimize thread exiting.
   InnoDB: Starting shutdown...
   InnoDB: Shutdown completed; log sequence number 1317928
   240629 17:55:15 completed OK!
```

It is not recommended to interrupt xtrabackup process while preparing backup because it may cause data files corruption and backup will become unusable. Backup validity is not guaranteed if prepare process was interrupted.(**不建议在准备备份时中断xtrabackup进程**，否则可能导致数据文件损坏，导致备份无法使用。如果准备过程中断，则不保证备份的有效性。)

### 在恢复之前，需要做好准备
> 因为备份如果中断了，那么备份文件可能无法被使用，因此需要做好备份前的准备

If you don’t want to save your backup, you can use the xtrabackup --move-back option which will move the backed up data to the datadir.
```txt
    # 执行之前需要先停止mysql-server 服务 ， 再删除 mysql-server 数据目录

    wei@Berries-Wang:$ ./xtrabackup --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf   --copy-back --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_backdir  
```

## Q&A
### 为什么恢复之前需要 --prepare
```txt
    Backup needs to be prepared before it can be restored.
    > https://docs.percona.com/percona-xtrabackup/2.4/backup_scenarios/full_backup.html#preparing-a-backup
```

---

## 参考资料
1. [The Backup Cycle - Full Backups](https://docs.percona.com/percona-xtrabackup/2.4/backup_scenarios/full_backup.html#preparing-a-backup)