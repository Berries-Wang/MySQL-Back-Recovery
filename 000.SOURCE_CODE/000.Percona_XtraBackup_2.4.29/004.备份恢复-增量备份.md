# 增量备份
Both the xtrabackup tool and the innobackupex tool support incremental backups. An incremental backup backs up only data that has changed since the last backup.

You can take multiple incremental backups between each full backup. For example, you can take a full backup once a week and an incremental backup every day, or a full backup every day and incremental backups each hour.(您可以在每次完整备份之间进行多个增量备份。例如，每周进行一次全量备份，每天进行一次增量备份，或者每天进行一次全量备份，每小时进行一次增量备份。)

Incremental backups work because each InnoDB page contains a log sequence number (LSN). The LSN is the system version number for the entire database. Each page’s LSN shows how recently it was changed.

An incremental backup copies each page whose LSN is newer than the previous incremental or full backup’s LSN. There are two algorithms in use to find the set of such pages to be copied. The first one, available with all the server types and versions, checks the page LSN directly by reading all the data pages. The second one, available with Percona Server for MySQL, enables the changed page tracking feature on the server, which will note the pages as they are being changed. This information will be then written out in a compact separate so-called bitmap file. The xtrabackup binary uses that file to read only the data pages it needs for the incremental backup. This features potentially saves many read requests. The latter algorithm is enabled by default if the xtrabackup binary finds the bitmap file. It is possible to specify xtrabackup --incremental-force-scan to read all the pages even if the bitmap data is available.(增量备份复制LSN比前一个增量备份或完整备份的LSN更新的每个页面。有两种算法用于查找要复制的页面集。第一种方法适用于所有服务器类型和版本，它通过读取所有数据页直接检查页面LSN。第二个是Percona Server for MySQL，它启用了服务器上的更改页面跟踪功能，当页面被更改时，它会记录下来。然后，这些信息将被写入一个紧凑的单独的所谓位图文件中。xtrabackup二进制文件使用该文件仅读取增量备份所需的数据页。这个特性可能会节省很多读请求。如果xtrabackup二进制文件找到位图文件，则默认启用后一种算法。可以指定xtrabackup—incremental-force-scan来读取所有页面，即使位图数据可用。)

```txt
   !!! Important 
   Incremental backups do not compare the data files to the previous backup’s data files. For this reason, running an incremental backup after a partial backup may lead to inconsistent data.（增量备份不会将数据文件与前一次备份的数据文件进行比较。因此，在进行部分备份后再进行增量备份，可能导致数据不一致。）
   
   Incremental backups read the pages and compare their LSN to the last backup’s LSN. You must have a full backup to recover the incremental changes. Without a full backup to act as a base, the incremental backups are useless.(增量备份读取页面，并将它们的LSN与上次备份的LSN进行比较。必须有完整备份才能恢复增量更改。如果没有完整备份作为基础，增量备份就毫无用处。)
   
   You can use the --incremental-lsn option to perform an incremental backup without even having the previous backup, if you know its LSN.(您可以使用--incremental-lsn选项来执行增量备份，甚至不需要之前的备份，如果您知道它的LSN。)
```

## Creating an Incremental Backup
```txt
    开始增量备份前，需要全量备份
```
To make an incremental backup, begin with a full backup as usual. The xtrabackup binary writes a file called xtrabackup_checkpoints into the backup’s target directory. This file contains a line showing the to_lsn, which is the database’s LSN at the end of the backup. Create the full backup with a following command:(要进行增量备份，请像往常一样从完全备份开始。xtrabackup二进制文件将一个名为xtrabackup_checkpoints的文件写入备份的目标目录。该文件包含一行显示to_lsn，这是备份结束时数据库的LSN。使用如下命令创建全量备份:)
```shell
  wei@Berries-Wang:$ ./xtrabackup --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf \
   --user=root \
   --password=123456 \
   -S /tmp/mysql3309.sock  \
   --backup \
   --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups
```

If you look at the xtrabackup_checkpoints file, you should see similar content depending on your LSN nuber:
```txt
     000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups/xtrabackup_checkpoints

     backup_type = full-backuped
     from_lsn = 0
     to_lsn = 1318013
     last_lsn = 1318022
     compact = 0
     recover_binlog_info = 0
     flushed_lsn = 1318022
```

Now that you have a full backup, you can make an incremental backup based on it. Use the following command:(现在你有了一个全量备份，那么现在，你可以基于这个全量备份进行增量备份)
```shell
    ./xtrabackup --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf \
    --user=root \
    --password=123456 \
    -S /tmp/mysql3309.sock \
    --backup \
    --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_1 \
    --incremental-basedir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups
```

The /data/backups/inc1/ directory should now contain delta files, such as ibdata1.delta and test/table1.ibd.delta. These represent the changes since the LSN 1318013. If you examine the xtrabackup_checkpoints file in this directory, you should see similar content to the following:
```txt
  000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_1/xtrabackup_checkpoints

  backup_type = incremental
  from_lsn = 1318013
  to_lsn = 1318013
  last_lsn = 1318022
  compact = 0
  recover_binlog_info = 0
  flushed_lsn = 1318022
```

from_lsn is the starting LSN of the backup and for incremental it has to be the same as to_lsn (if it is the last checkpoint) of the previous/base backup.

It’s now possible to use this directory as the base for yet another incremental backup:(基于上一次的增量备份开始下一次的增量备份)
```shell
    ./xtrabackup --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf \
    --user=root \
    --password=123456 \
    -S /tmp/mysql3309.sock \
    --backup \
    --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_2 \
    --incremental-basedir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_1


    000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_2/xtrabackup_checkpoints
    backup_type = incremental
    from_lsn = 1318013
    to_lsn = 1318013
    last_lsn = 1318022
    compact = 0
    recover_binlog_info = 0
    flushed_lsn = 1318022
```

## 恢复
The xtrabackup --prepare step for incremental backups is not the same as for full backups. In full backups, two types of operations are performed to make the database consistent: committed transactions are replayed from the log file against the data files, and uncommitted transactions are rolled back. You must skip the rollback of uncommitted transactions when preparing an incremental backup, because transactions that were uncommitted at the time of your backup may be in progress, and it’s likely that they will be committed in the next incremental backup. You should use the xtrabackup --apply-log-only option to prevent the rollback phase.(增量备份的xtrabackup --prepare步骤与完全备份不同。在完全备份中，执行两种类型的操作以使数据库保持一致:根据数据文件从日志文件重放已提交的事务，回滚未提交的事务。在准备增量备份时，必须跳过未提交事务的回滚，因为在备份时未提交的事务可能正在进行中，并且很可能在下一次增量备份中提交。您应该使用xtrabackup --apply-log-only选项来防止回滚阶段。)

### 1. prepare 
Beginning with the full backup you created, you can prepare it, and then apply the incremental differences to it. Recall that you have the following backups:

#### 1.1 prepare 第一次的全量备份
To prepare the base backup, you need to run xtrabackup --prepare as usual, but prevent the rollback phase
```shell
   ./xtrabackup --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf \
    --user=root \
    --password=123456 \
    -S /tmp/mysql3309.sock \
    --prepare \
    --apply-log-only \
    --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups
```

#### 1.2 prepare 以此处理之后的增量备份
##### 1.2.1 prepare 第一次的增量备份
To apply the first incremental backup to the full backup, run the following command:
```shell
    ./xtrabackup --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf \
    --user=root \
    --password=123456 \
    -S /tmp/mysql3309.sock \
    --prepare \
    --apply-log-only \
    --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups \
    --incremental-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_1
```

[**最终的恢复目录:'/data/backups/base'**]This applies the delta files to the files in /data/backups/base, which rolls them forward in time to the time of the incremental backup. It then applies the redo log as usual to the result. The final data is in /data/backups/base, not in the incremental directory. You should see an output similar to:
```txt
     incremental backup from 1318013 is enabled.
     xtrabackup: cd to /home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups/
     xtrabackup: This target seems to be already prepared with --apply-log-only.
     InnoDB: Number of pools: 1
     xtrabackup: xtrabackup_logfile detected: size=8388608, start_lsn=(1318013)
     xtrabackup: using the following InnoDB configuration for recovery:
     xtrabackup:   innodb_data_home_dir = .
     xtrabackup:   innodb_data_file_path = ibdata1:12M:autoextend
     xtrabackup:   innodb_log_group_home_dir = /home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_1/
     xtrabackup:   innodb_log_files_in_group = 1
     xtrabackup:   innodb_log_file_size = 8388608
     xtrabackup: Generating a list of tablespaces
```

Again, the LSN should match what you saw from your earlier inspection of the first incremental backup. If you restore the files from /data/backups/base, you should see the state of the database as of the first incremental backup.

Preparing the second incremental backup is a similar process: apply the deltas to the (modified) base backup, and you will roll its data forward in time to the point of the second incremental backup:
```shell
    ./xtrabackup --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf \
    --user=root \
    --password=123456 \
    -S /tmp/mysql3309.sock \
    --prepare \
    --apply-log-only \
    --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups \
    --incremental-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/backup_inc_2
```
### 2. 恢复
[**最终恢复**]Once prepared, incremental backups are the same as the full backups and they can be restored in the same way.
```shell
    # 执行之前需要先停止mysql-server 服务 ， 再删除 mysql-server 数据目录

    ./xtrabackup \
    --defaults-file=/home/wei/WorkSpace/Open_Source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/sys/my.cnf \
    --copy-back \
    --target-dir=/home/wei/WorkSpace/Open_Source/Percona_XtraBackup/000.SOURCE_CODE/000.Percona_XtraBackup_2.4.29/001.build-output/wei_back_dir/full_back_ups
```


---

## Q&A
### 为什么恢复之前需要 --prepare
```txt
    Backup needs to be prepared before it can be restored.
    > https://docs.percona.com/percona-xtrabackup/2.4/backup_scenarios/full_backup.html#preparing-a-backup
```

## 参考资料
1. [Incremental Backup](https://docs.percona.com/percona-xtrabackup/2.4/backup_scenarios/incremental_backup.html#preparing-the-incremental-backups)